<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Crawler Dashboard — Door Hinge Knowledge Hub</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #222222;
      --accent: #edd144;
      --accent-hover: #b79310;
      --bg: #ffffff;
      --bg-alt: #f7f7f7;
      --border: #dbe2ea;
      --text: #333333;
      --text-light: #666666;
      --highlight: #fff9e0;
      --green: #22c55e;
      --red: #ef4444;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: "Source Sans Pro", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      color: var(--text);
      line-height: 1.6;
      max-width: 1100px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
      background: var(--bg);
    }
    header {
      border-bottom: 2px solid var(--accent);
      padding-bottom: 1rem;
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .site-name {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
    }
    .site-name span { color: var(--text-light); font-weight: 400; font-size: 0.9rem; }
    .back-link { color: var(--text-light); text-decoration: none; font-size: 0.9rem; }
    .back-link:hover { color: var(--accent-hover); }

    h1 { font-size: 1.6rem; color: var(--primary); margin-bottom: 1.5rem; }
    h2 { font-size: 1.2rem; color: var(--primary); margin: 1.5rem 0 0.8rem; }

    /* Auth */
    .auth-form { text-align: center; padding: 4rem 2rem; }
    .auth-form input {
      padding: 0.6rem 1rem;
      border: 2px solid var(--border);
      border-radius: 6px;
      font-size: 1rem;
      width: 300px;
      font-family: inherit;
    }
    .auth-form input:focus { outline: none; border-color: var(--accent); }
    .auth-form button {
      padding: 0.6rem 1.5rem;
      background: var(--accent);
      color: var(--primary);
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      margin-left: 0.5rem;
      font-family: inherit;
    }
    .auth-form button:hover { background: var(--accent-hover); color: white; }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .stat-card {
      background: var(--bg-alt);
      border-radius: 8px;
      padding: 1.2rem;
      text-align: center;
      border: 1px solid var(--border);
    }
    .stat-card .number {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary);
      line-height: 1.2;
    }
    .stat-card .label {
      font-size: 0.85rem;
      color: var(--text-light);
      margin-top: 0.3rem;
    }

    /* Bot Table */
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    th, td {
      text-align: left;
      padding: 0.6rem 0.8rem;
      border-bottom: 1px solid var(--border);
    }
    th {
      background: var(--bg-alt);
      font-weight: 700;
      color: var(--primary);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    td { font-size: 0.95rem; }
    tr:hover { background: var(--highlight); }

    .bot-badge {
      display: inline-block;
      padding: 0.15rem 0.6rem;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
      background: var(--highlight);
      color: var(--accent-hover);
      border: 1px solid var(--accent);
    }
    .org-badge {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      background: var(--bg-alt);
      color: var(--text-light);
    }

    /* Chart */
    .chart-container {
      background: var(--bg-alt);
      border-radius: 8px;
      padding: 1.5rem;
      margin: 1rem 0;
      border: 1px solid var(--border);
    }
    .bar-row {
      display: flex;
      align-items: center;
      margin: 0.4rem 0;
    }
    .bar-label {
      width: 120px;
      font-size: 0.85rem;
      color: var(--text-light);
      flex-shrink: 0;
    }
    .bar-track {
      flex: 1;
      height: 24px;
      background: var(--bg);
      border-radius: 4px;
      overflow: hidden;
      margin: 0 0.5rem;
    }
    .bar-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 4px;
      min-width: 2px;
      transition: width 0.3s ease;
    }
    .bar-count {
      width: 50px;
      font-size: 0.85rem;
      font-weight: 600;
      text-align: right;
      flex-shrink: 0;
    }

    /* Recent Visits */
    .visit-log {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 8px;
    }
    .visit-item {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding: 0.5rem 0.8rem;
      border-bottom: 1px solid var(--border);
      font-size: 0.85rem;
    }
    .visit-item:last-child { border-bottom: none; }
    .visit-time { color: var(--text-light); flex-shrink: 0; width: 140px; }
    .visit-path { flex: 1; font-family: monospace; font-size: 0.8rem; }

    .loading { text-align: center; padding: 2rem; color: var(--text-light); }
    .error-msg { color: var(--red); text-align: center; padding: 1rem; }
    .empty-state { text-align: center; padding: 2rem; color: var(--text-light); }

    /* Tab nav */
    .tabs {
      display: flex;
      gap: 0;
      border-bottom: 2px solid var(--border);
      margin-bottom: 1.5rem;
    }
    .tab {
      padding: 0.6rem 1.2rem;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-light);
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
      font-family: inherit;
      font-size: 0.95rem;
      background: none;
      border-top: none;
      border-left: none;
      border-right: none;
    }
    .tab:hover { color: var(--primary); }
    .tab.active { color: var(--primary); border-bottom-color: var(--accent); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* AEO Score */
    .score-circle {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      font-weight: 700;
      margin: 0 auto 0.5rem;
      border: 4px solid var(--border);
    }
    .score-high { border-color: var(--green); color: var(--green); }
    .score-mid { border-color: var(--accent); color: var(--accent-hover); }
    .score-low { border-color: var(--red); color: var(--red); }
    .check-row {
      display: flex;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }
    .check-row:last-child { border-bottom: none; }
    .check-icon { width: 24px; flex-shrink: 0; font-size: 1.1rem; }
    .check-name { flex: 1; font-weight: 600; font-size: 0.9rem; }
    .check-score { width: 60px; text-align: right; font-size: 0.85rem; font-weight: 600; }
    .check-pass { color: var(--green); }
    .check-partial { color: var(--accent-hover); }
    .check-fail { color: var(--red); }
    .site-check-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.8rem;
      margin: 1rem 0;
    }
    .site-check-item {
      background: var(--bg-alt);
      border-radius: 8px;
      padding: 0.8rem;
      text-align: center;
      border: 1px solid var(--border);
    }
    .site-check-item .icon { font-size: 1.5rem; }
    .site-check-item .name { font-size: 0.8rem; color: var(--text-light); margin-top: 0.3rem; }
    .page-score-card {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      margin: 0.8rem 0;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    .page-score-card:hover { border-color: var(--accent); }
    .page-score-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .page-score-header code { font-size: 0.85rem; }
    .page-score-badge {
      padding: 0.2rem 0.8rem;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 700;
    }
    .page-score-details { display: none; margin-top: 0.8rem; padding-top: 0.8rem; border-top: 1px solid var(--border); }
    .page-score-card.open .page-score-details { display: block; }
    .scan-btn {
      padding: 0.5rem 1.2rem;
      background: var(--accent);
      color: var(--primary);
      border: none;
      border-radius: 6px;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.9rem;
    }
    .scan-btn:hover { background: var(--accent-hover); color: white; }
    .scan-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Crawler Cards Grid */
    .crawler-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1rem;
    }
    .crawler-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1.2rem;
      position: relative;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .crawler-card:hover { border-color: var(--accent); box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .crawler-card.active { border-left: 4px solid var(--green); }
    .crawler-card.awaiting { border-left: 4px solid var(--border); opacity: 0.65; }
    .crawler-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.8rem; }
    .crawler-card-info { display: flex; align-items: center; gap: 0.6rem; }
    .crawler-card-icon { width: 28px; height: 28px; flex-shrink: 0; border-radius: 6px; }
    .crawler-card-name { font-size: 1rem; font-weight: 700; color: var(--primary); }
    .crawler-card-org { font-size: 0.75rem; color: var(--text-light); margin-top: 0.1rem; }
    .crawler-card-status {
      font-size: 0.7rem;
      padding: 0.15rem 0.5rem;
      border-radius: 10px;
      font-weight: 600;
      white-space: nowrap;
    }
    .status-active { background: #dcfce7; color: #166534; }
    .status-awaiting { background: var(--bg-alt); color: var(--text-light); }
    .crawler-card-count { font-size: 2rem; font-weight: 700; color: var(--primary); line-height: 1.2; }
    .crawler-card-today { font-size: 0.8rem; color: var(--green); font-weight: 600; }
    .crawler-card-today.zero { color: var(--text-light); }
  </style>
</head>
<body>

<header>
  <div class="site-name">AI Crawler Dashboard <span>door.watersonusa.com</span></div>
  <a href="/" class="back-link">&larr; Back to Knowledge Hub</a>
</header>

<!-- Auth Screen -->
<div id="auth-screen" class="auth-form">
  <h1>AI Crawler Dashboard</h1>
  <p style="color: var(--text-light); margin-bottom: 1.5rem;">Enter your dashboard key to view AI crawler analytics</p>
  <form onsubmit="authenticate(event)">
    <input type="password" id="key-input" placeholder="Dashboard Key" autocomplete="off">
    <button type="submit">View Dashboard</button>
  </form>
  <p id="auth-error" class="error-msg" style="display:none; margin-top:1rem;"></p>
</div>

<!-- Dashboard (hidden until auth) -->
<div id="dashboard" style="display: none;">
  <h1>AI Crawler Analytics</h1>

  <!-- Summary Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="number" id="total-bots">-</div>
      <div class="label">Unique AI Crawlers</div>
    </div>
    <div class="stat-card">
      <div class="number" id="total-visits">-</div>
      <div class="label">Total AI Visits</div>
    </div>
    <div class="stat-card">
      <div class="number" id="today-visits">-</div>
      <div class="label">Today</div>
    </div>
    <div class="stat-card">
      <div class="number" id="week-visits">-</div>
      <div class="label">Last 7 Days</div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-tab="crawlers">Live Crawlers</button>
    <button class="tab" data-tab="aeo">AEO Score</button>
    <button class="tab" data-tab="daily">Daily Trends</button>
    <button class="tab" data-tab="pages">Pages Crawled</button>
    <button class="tab" data-tab="recent">Recent Visits</button>
  </div>

  <!-- Live Crawlers Tab -->
  <div id="tab-crawlers" class="tab-content active">
    <h2>Live AI Crawler Activity</h2>
    <p style="color: var(--text-light); font-size: 0.85rem; margin-bottom: 1rem;">Tracked via Edge Middleware. Data refreshes on page load.</p>
    <div id="crawler-cards" class="crawler-grid">
      <div class="loading">Loading...</div>
    </div>
  </div>

  <!-- AEO Score Tab -->
  <div id="tab-aeo" class="tab-content">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h2>AEO Friendliness Score</h2>
      <button class="scan-btn" id="scan-btn" onclick="runAeoScan()">Run Scan</button>
    </div>
    <p style="color: var(--text-light); font-size: 0.85rem; margin-bottom: 1rem;">Scans all pages for AI-friendliness: JSON-LD, FAQ, meta tags, llms.txt, and more.</p>

    <!-- Site-wide checks -->
    <h3 style="margin-top: 1.5rem;">Site-Wide Files</h3>
    <div id="site-checks" class="site-check-grid">
      <div class="empty-state">Click "Run Scan" to start</div>
    </div>

    <!-- Overall score -->
    <div id="aeo-overall" style="text-align: center; margin: 1.5rem 0; display: none;">
      <div id="aeo-score-circle" class="score-circle">—</div>
      <div style="font-size: 0.9rem; color: var(--text-light);">Average AEO Score</div>
    </div>

    <!-- Per-page scores -->
    <h3>Page Scores</h3>
    <div id="aeo-pages">
      <div class="empty-state">Click "Run Scan" to start</div>
    </div>
  </div>

  <!-- Daily Tab -->
  <div id="tab-daily" class="tab-content">
    <h2>Daily Activity (Last 7 Days)</h2>
    <div id="daily-chart" class="chart-container">
      <div class="loading">Loading...</div>
    </div>
  </div>

  <!-- Pages Tab -->
  <div id="tab-pages" class="tab-content">
    <h2>Most Crawled Pages</h2>
    <table id="pages-table">
      <thead>
        <tr><th>Page</th><th>Crawler</th><th>Hits</th></tr>
      </thead>
      <tbody id="pages-table-body"></tbody>
    </table>
  </div>

  <!-- Recent Tab -->
  <div id="tab-recent" class="tab-content">
    <h2>Recent AI Visits (Last 100)</h2>
    <div id="recent-log" class="visit-log">
      <div class="loading">Loading...</div>
    </div>
  </div>
</div>

<script>
const ALL_BOTS = [
  { id: "GPTBot", name: "GPTBot", org: "OpenAI", icon: "https://cdn.simpleicons.org/openai/412991" },
  { id: "ChatGPT-User", name: "ChatGPT", org: "OpenAI", icon: "https://cdn.simpleicons.org/openai/412991" },
  { id: "OAI-SearchBot", name: "OAI Search", org: "OpenAI", icon: "https://cdn.simpleicons.org/openai/412991" },
  { id: "ClaudeBot", name: "ClaudeBot", org: "Anthropic", icon: "https://cdn.simpleicons.org/anthropic/191919" },
  { id: "Anthropic-AI", name: "Anthropic AI", org: "Anthropic", icon: "https://cdn.simpleicons.org/anthropic/191919" },
  { id: "PerplexityBot", name: "PerplexityBot", org: "Perplexity", icon: "https://cdn.simpleicons.org/perplexity/1FB8CD" },
  { id: "Bytespider", name: "Bytespider", org: "ByteDance", icon: "https://cdn.simpleicons.org/bytedance/222222" },
  { id: "Google-Extended", name: "Google AI", org: "Google", icon: "https://cdn.simpleicons.org/google/4285F4" },
  { id: "Bingbot", name: "Bingbot", org: "Microsoft", icon: "https://cdn.simpleicons.org/microsoftbing/258FFA" },
  { id: "Applebot", name: "Applebot", org: "Apple", icon: "https://cdn.simpleicons.org/apple/000000" },
  { id: "Meta-ExternalAgent", name: "Meta AI", org: "Meta", icon: "https://cdn.simpleicons.org/meta/0081FB" },
  { id: "Amazonbot", name: "Amazonbot", org: "Amazon", icon: "https://cdn.simpleicons.org/amazon/FF9900" },
  { id: "CCBot", name: "CCBot", org: "Common Crawl", icon: "https://cdn.simpleicons.org/databricks/FF3621" },
  { id: "Cohere-ai", name: "Cohere", org: "Cohere", icon: "https://cdn.simpleicons.org/cohere/39594D" },
  { id: "YouBot", name: "YouBot", org: "You.com", icon: "https://cdn.simpleicons.org/yourdotcom/222222" },
  { id: "PetalBot", name: "PetalBot", org: "Huawei", icon: "https://cdn.simpleicons.org/huawei/FF0000" },
  { id: "Diffbot", name: "Diffbot", org: "Diffbot", icon: "https://cdn.simpleicons.org/diaspora/222222" },
];

const CHECK_LABELS = {
  jsonLd: "JSON-LD Structured Data",
  faqSchema: "FAQ Schema",
  metaDescription: "Meta Description",
  openGraph: "Open Graph Tags",
  pageTitle: "Page Title",
  headingStructure: "Heading Structure (H1/H2)",
  faqContent: "FAQ Content",
  quickFacts: "Quick Facts Table",
  sourceAttribution: "Source Attribution",
  canonical: "Canonical URL",
  comparisonTable: "Comparison Table",
  blockquoteSummary: "Blockquote Summary",
};

let dashboardKey = "";
let data = null;

function authenticate(e) {
  e.preventDefault();
  dashboardKey = document.getElementById("key-input").value.trim();
  if (!dashboardKey) return;
  loadDashboard();
}

async function loadDashboard() {
  try {
    const resp = await fetch(`/api/ai-crawlers?key=${encodeURIComponent(dashboardKey)}`);
    if (resp.status === 401) {
      document.getElementById("auth-error").textContent = "Invalid key. Please try again.";
      document.getElementById("auth-error").style.display = "block";
      return;
    }
    data = await resp.json();
    if (data.error) throw new Error(data.error);

    document.getElementById("auth-screen").style.display = "none";
    document.getElementById("dashboard").style.display = "block";
    localStorage.setItem("door-site-dash-key", dashboardKey);
    renderDashboard();
  } catch (err) {
    document.getElementById("auth-error").textContent = "Error: " + err.message;
    document.getElementById("auth-error").style.display = "block";
  }
}

function timeAgo(ts) {
  if (!ts) return null;
  const diff = Date.now() - new Date(ts).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return "just now";
  if (mins < 60) return mins + "m ago";
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return hrs + "h ago";
  const days = Math.floor(hrs / 24);
  return days + "d ago";
}

function renderDashboard() {
  // Summary cards
  document.getElementById("total-bots").textContent = data.summary.totalBots;
  document.getElementById("total-visits").textContent = data.summary.totalVisits.toLocaleString();
  const today = new Date().toISOString().slice(0, 10);
  const todayVisits = data.daily[today]
    ? Object.values(data.daily[today]).reduce((a, b) => a + b, 0) : 0;
  document.getElementById("today-visits").textContent = todayVisits.toLocaleString();
  const weekVisits = Object.values(data.daily).reduce(
    (sum, day) => sum + Object.values(day).reduce((a, b) => a + b, 0), 0);
  document.getElementById("week-visits").textContent = weekVisits.toLocaleString();

  renderCrawlerCards();
  renderDailyChart();
  renderPagesTable();
  renderRecentLog();
}

function renderCrawlerCards() {
  const container = document.getElementById("crawler-cards");
  const totals = data.totals || {};
  const today = new Date().toISOString().slice(0, 10);
  const todayData = data.daily[today] || {};

  // Find last seen time for each bot from recent visits
  const lastSeen = {};
  for (const v of (data.recentVisits || [])) {
    if (v.bot && !lastSeen[v.bot]) lastSeen[v.bot] = v.ts;
  }

  const cards = ALL_BOTS.map(bot => {
    const total = Number(totals[bot.id] || 0);
    const todayCount = Number(todayData[bot.id] || 0);
    const lastTs = lastSeen[bot.id];
    const isActive = total > 0;

    return `
      <div class="crawler-card ${isActive ? 'active' : 'awaiting'}">
        <div class="crawler-card-header">
          <div class="crawler-card-info">
            <img class="crawler-card-icon" src="${bot.icon}" alt="${bot.org}" onerror="this.style.display='none'">
            <div>
              <div class="crawler-card-name">${bot.name}</div>
              <div class="crawler-card-org">${bot.org}</div>
            </div>
          </div>
          <span class="crawler-card-status ${isActive ? 'status-active' : 'status-awaiting'}">
            ${isActive ? (lastTs ? timeAgo(lastTs) : 'Seen') : 'Awaiting'}
          </span>
        </div>
        <div class="crawler-card-count">${isActive ? total.toLocaleString() : '—'}</div>
        <div class="crawler-card-today ${todayCount ? '' : 'zero'}">
          ${isActive ? (todayCount ? '+' + todayCount + ' today' : 'No visits today') : 'Awaiting...'}
        </div>
      </div>
    `;
  });

  container.innerHTML = cards.join("");
}

function renderDailyChart() {
  const container = document.getElementById("daily-chart");
  const daily = data.daily || {};
  const dates = Object.keys(daily).sort();
  if (!dates.length) {
    container.innerHTML = '<div class="empty-state">No daily data yet.</div>';
    return;
  }
  const maxDaily = Math.max(...dates.map(d =>
    Object.values(daily[d]).reduce((a, b) => a + b, 0)), 1);
  container.innerHTML = dates.map(date => {
    const dayTotal = Object.values(daily[date]).reduce((a, b) => a + b, 0);
    return `<div class="bar-row">
      <div class="bar-label">${date}</div>
      <div class="bar-track"><div class="bar-fill" style="width: ${(dayTotal / maxDaily * 100).toFixed(1)}%"></div></div>
      <div class="bar-count">${dayTotal}</div>
    </div>`;
  }).join("");
}

function renderPagesTable() {
  const tbody = document.getElementById("pages-table-body");
  const pages = data.pages || {};
  const rows = [];
  for (const [bot, pageData] of Object.entries(pages)) {
    for (const [path, count] of Object.entries(pageData)) {
      rows.push({ bot, path, count: Number(count) });
    }
  }
  rows.sort((a, b) => b.count - a.count);
  if (!rows.length) {
    tbody.innerHTML = '<tr><td colspan="3" class="empty-state">No page data yet</td></tr>';
    return;
  }
  tbody.innerHTML = rows.slice(0, 50).map(r =>
    `<tr><td><code>${r.path}</code></td><td><span class="bot-badge">${r.bot}</span></td><td><strong>${r.count}</strong></td></tr>`
  ).join("");
}

function renderRecentLog() {
  const container = document.getElementById("recent-log");
  const visits = data.recentVisits || [];
  if (!visits.length) {
    container.innerHTML = '<div class="empty-state">No recent visits recorded.</div>';
    return;
  }
  container.innerHTML = visits.map(v =>
    `<div class="visit-item">
      <span class="visit-time">${v.ts ? new Date(v.ts).toLocaleString() : "—"}</span>
      <span class="bot-badge">${v.bot || "?"}</span>
      <span class="visit-path">${v.path || "/"}</span>
    </div>`
  ).join("");
}

// AEO Scan
async function runAeoScan() {
  const btn = document.getElementById("scan-btn");
  btn.disabled = true;
  btn.textContent = "Scanning...";
  document.getElementById("aeo-pages").innerHTML = '<div class="loading">Scanning all pages...</div>';

  try {
    const resp = await fetch(`/api/aeo-scan?key=${encodeURIComponent(dashboardKey)}`);
    const result = await resp.json();
    if (result.error) throw new Error(result.error);
    renderAeoResults(result);
  } catch (err) {
    document.getElementById("aeo-pages").innerHTML = `<div class="error-msg">Scan failed: ${err.message}</div>`;
  } finally {
    btn.disabled = false;
    btn.textContent = "Run Scan";
  }
}

function renderAeoResults(result) {
  // Site checks
  const sc = result.siteChecks || {};
  document.getElementById("site-checks").innerHTML = [
    { name: "llms.txt", ok: sc.llmsTxt?.found },
    { name: "llms-full.txt", ok: sc.llmsFullTxt?.found },
    { name: "robots.txt", ok: sc.robotsTxt?.found },
    { name: "sitemap.xml", ok: sc.sitemapXml?.found },
  ].map(c => `
    <div class="site-check-item">
      <div class="icon">${c.ok ? '&#9989;' : '&#10060;'}</div>
      <div class="name">${c.name}</div>
    </div>
  `).join("");

  // Overall score
  const overall = document.getElementById("aeo-overall");
  overall.style.display = "block";
  const circle = document.getElementById("aeo-score-circle");
  const score = result.overallScore;
  circle.textContent = score;
  circle.className = "score-circle " + (score >= 75 ? "score-high" : score >= 50 ? "score-mid" : "score-low");

  // Per-page
  const container = document.getElementById("aeo-pages");
  const sorted = (result.pages || []).sort((a, b) => (b.score || 0) - (a.score || 0));

  container.innerHTML = sorted.map((p, i) => {
    const s = p.score || 0;
    const cls = s >= 75 ? "check-pass" : s >= 50 ? "check-partial" : "check-fail";
    const checks = p.checks || {};

    return `
      <div class="page-score-card" onclick="this.classList.toggle('open')">
        <div class="page-score-header">
          <code>${p.path}</code>
          <span class="page-score-badge ${cls}" style="background: ${s >= 75 ? '#dcfce7' : s >= 50 ? '#fff9e0' : '#fef2f2'}">${s}/${p.maxScore || 100}</span>
        </div>
        <div class="page-score-details">
          ${Object.entries(checks).map(([key, c]) => {
            const cCls = c.score === c.max ? "check-pass" : c.score > 0 ? "check-partial" : "check-fail";
            const icon = c.score === c.max ? "&#9989;" : c.score > 0 ? "&#9888;&#65039;" : "&#10060;";
            return `<div class="check-row">
              <span class="check-icon">${icon}</span>
              <span class="check-name">${CHECK_LABELS[key] || key}</span>
              <span class="check-score ${cCls}">${c.score}/${c.max}</span>
            </div>`;
          }).join("")}
        </div>
      </div>
    `;
  }).join("");
}

// Tab switching
document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById("tab-" + tab.dataset.tab).classList.add("active");
  });
});

// Auto-login with saved key
const savedKey = localStorage.getItem("door-site-dash-key");
if (savedKey) {
  dashboardKey = savedKey;
  document.getElementById("key-input").value = savedKey;
  loadDashboard();
}
</script>

</body>
</html>
