<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Crawler Dashboard — Door Hinge Knowledge Hub</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #222222;
      --accent: #edd144;
      --accent-hover: #b79310;
      --bg: #ffffff;
      --bg-alt: #f7f7f7;
      --border: #dbe2ea;
      --text: #333333;
      --text-light: #666666;
      --highlight: #fff9e0;
      --green: #22c55e;
      --red: #ef4444;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: "Source Sans Pro", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      color: var(--text);
      line-height: 1.6;
      max-width: 1100px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
      background: var(--bg);
    }
    header {
      border-bottom: 2px solid var(--accent);
      padding-bottom: 1rem;
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .site-name {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
    }
    .site-name span { color: var(--text-light); font-weight: 400; font-size: 0.9rem; }
    .back-link { color: var(--text-light); text-decoration: none; font-size: 0.9rem; }
    .back-link:hover { color: var(--accent-hover); }

    h1 { font-size: 1.6rem; color: var(--primary); margin-bottom: 1.5rem; }
    h2 { font-size: 1.2rem; color: var(--primary); margin: 1.5rem 0 0.8rem; }

    /* Auth */
    .auth-form { text-align: center; padding: 4rem 2rem; }
    .auth-form input {
      padding: 0.6rem 1rem;
      border: 2px solid var(--border);
      border-radius: 6px;
      font-size: 1rem;
      width: 300px;
      font-family: inherit;
    }
    .auth-form input:focus { outline: none; border-color: var(--accent); }
    .auth-form button {
      padding: 0.6rem 1.5rem;
      background: var(--accent);
      color: var(--primary);
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      margin-left: 0.5rem;
      font-family: inherit;
    }
    .auth-form button:hover { background: var(--accent-hover); color: white; }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .stat-card {
      background: var(--bg-alt);
      border-radius: 8px;
      padding: 1.2rem;
      text-align: center;
      border: 1px solid var(--border);
    }
    .stat-card .number {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary);
      line-height: 1.2;
    }
    .stat-card .label {
      font-size: 0.85rem;
      color: var(--text-light);
      margin-top: 0.3rem;
    }

    /* Bot Table */
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    th, td {
      text-align: left;
      padding: 0.6rem 0.8rem;
      border-bottom: 1px solid var(--border);
    }
    th {
      background: var(--bg-alt);
      font-weight: 700;
      color: var(--primary);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    td { font-size: 0.95rem; }
    tr:hover { background: var(--highlight); }

    .bot-badge {
      display: inline-block;
      padding: 0.15rem 0.6rem;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
      background: var(--highlight);
      color: var(--accent-hover);
      border: 1px solid var(--accent);
    }
    .org-badge {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      background: var(--bg-alt);
      color: var(--text-light);
    }

    /* Chart */
    .chart-container {
      background: var(--bg-alt);
      border-radius: 8px;
      padding: 1.5rem;
      margin: 1rem 0;
      border: 1px solid var(--border);
    }
    .bar-row {
      display: flex;
      align-items: center;
      margin: 0.4rem 0;
    }
    .bar-label {
      width: 120px;
      font-size: 0.85rem;
      color: var(--text-light);
      flex-shrink: 0;
    }
    .bar-track {
      flex: 1;
      height: 24px;
      background: var(--bg);
      border-radius: 4px;
      overflow: hidden;
      margin: 0 0.5rem;
    }
    .bar-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 4px;
      min-width: 2px;
      transition: width 0.3s ease;
    }
    .bar-count {
      width: 50px;
      font-size: 0.85rem;
      font-weight: 600;
      text-align: right;
      flex-shrink: 0;
    }

    /* Recent Visits */
    .visit-log {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 8px;
    }
    .visit-item {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding: 0.5rem 0.8rem;
      border-bottom: 1px solid var(--border);
      font-size: 0.85rem;
    }
    .visit-item:last-child { border-bottom: none; }
    .visit-time { color: var(--text-light); flex-shrink: 0; width: 140px; }
    .visit-path { flex: 1; font-family: monospace; font-size: 0.8rem; }

    .loading { text-align: center; padding: 2rem; color: var(--text-light); }
    .error-msg { color: var(--red); text-align: center; padding: 1rem; }
    .empty-state { text-align: center; padding: 2rem; color: var(--text-light); }

    /* Tab nav */
    .tabs {
      display: flex;
      gap: 0;
      border-bottom: 2px solid var(--border);
      margin-bottom: 1.5rem;
    }
    .tab {
      padding: 0.6rem 1.2rem;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-light);
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
      font-family: inherit;
      font-size: 0.95rem;
      background: none;
      border-top: none;
      border-left: none;
      border-right: none;
    }
    .tab:hover { color: var(--primary); }
    .tab.active { color: var(--primary); border-bottom-color: var(--accent); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>
<body>

<header>
  <div class="site-name">AI Crawler Dashboard <span>door.watersonusa.com</span></div>
  <a href="/" class="back-link">&larr; Back to Knowledge Hub</a>
</header>

<!-- Auth Screen -->
<div id="auth-screen" class="auth-form">
  <h1>AI Crawler Dashboard</h1>
  <p style="color: var(--text-light); margin-bottom: 1.5rem;">Enter your dashboard key to view AI crawler analytics</p>
  <form onsubmit="authenticate(event)">
    <input type="password" id="key-input" placeholder="Dashboard Key" autocomplete="off">
    <button type="submit">View Dashboard</button>
  </form>
  <p id="auth-error" class="error-msg" style="display:none; margin-top:1rem;"></p>
</div>

<!-- Dashboard (hidden until auth) -->
<div id="dashboard" style="display: none;">
  <h1>AI Crawler Analytics</h1>

  <!-- Summary Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="number" id="total-bots">-</div>
      <div class="label">Unique AI Crawlers</div>
    </div>
    <div class="stat-card">
      <div class="number" id="total-visits">-</div>
      <div class="label">Total AI Visits</div>
    </div>
    <div class="stat-card">
      <div class="number" id="today-visits">-</div>
      <div class="label">Today</div>
    </div>
    <div class="stat-card">
      <div class="number" id="week-visits">-</div>
      <div class="label">Last 7 Days</div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-tab="overview">Overview</button>
    <button class="tab" data-tab="daily">Daily Trends</button>
    <button class="tab" data-tab="pages">Pages Crawled</button>
    <button class="tab" data-tab="recent">Recent Visits</button>
  </div>

  <!-- Overview Tab -->
  <div id="tab-overview" class="tab-content active">
    <h2>Visits by AI Crawler</h2>
    <div id="bot-chart" class="chart-container">
      <div class="loading">Loading...</div>
    </div>
    <table id="bot-table">
      <thead>
        <tr><th>Crawler</th><th>Organization</th><th>Total Visits</th></tr>
      </thead>
      <tbody id="bot-table-body"></tbody>
    </table>
  </div>

  <!-- Daily Tab -->
  <div id="tab-daily" class="tab-content">
    <h2>Daily Activity (Last 7 Days)</h2>
    <div id="daily-chart" class="chart-container">
      <div class="loading">Loading...</div>
    </div>
  </div>

  <!-- Pages Tab -->
  <div id="tab-pages" class="tab-content">
    <h2>Most Crawled Pages</h2>
    <table id="pages-table">
      <thead>
        <tr><th>Page</th><th>Crawler</th><th>Hits</th></tr>
      </thead>
      <tbody id="pages-table-body"></tbody>
    </table>
  </div>

  <!-- Recent Tab -->
  <div id="tab-recent" class="tab-content">
    <h2>Recent AI Visits (Last 100)</h2>
    <div id="recent-log" class="visit-log">
      <div class="loading">Loading...</div>
    </div>
  </div>
</div>

<script>
const AI_ORGS = {
  GPTBot: "OpenAI", "ChatGPT-User": "OpenAI", "OAI-SearchBot": "OpenAI",
  "Google-Extended": "Google", Googlebot: "Google",
  "Anthropic-AI": "Anthropic", ClaudeBot: "Anthropic", "Claude-Web": "Anthropic",
  PerplexityBot: "Perplexity", Bytespider: "ByteDance", CCBot: "Common Crawl",
  "Cohere-ai": "Cohere", "Meta-ExternalAgent": "Meta", "Meta-ExternalFetcher": "Meta",
  Applebot: "Apple", "Applebot-Extended": "Apple", Bingbot: "Microsoft",
  "FacebookExternalHit": "Meta", Amazonbot: "Amazon", YouBot: "You.com",
  AI2Bot: "AI2", "Ai2Bot-Dolma": "AI2", Diffbot: "Diffbot", PetalBot: "Petal",
};

let dashboardKey = "";
let data = null;

function authenticate(e) {
  e.preventDefault();
  dashboardKey = document.getElementById("key-input").value.trim();
  if (!dashboardKey) return;
  loadDashboard();
}

async function loadDashboard() {
  try {
    const resp = await fetch(`/api/ai-crawlers?key=${encodeURIComponent(dashboardKey)}`);
    if (resp.status === 401) {
      document.getElementById("auth-error").textContent = "Invalid key. Please try again.";
      document.getElementById("auth-error").style.display = "block";
      return;
    }
    data = await resp.json();
    if (data.error) throw new Error(data.error);

    document.getElementById("auth-screen").style.display = "none";
    document.getElementById("dashboard").style.display = "block";
    localStorage.setItem("door-site-dash-key", dashboardKey);
    renderDashboard();
  } catch (err) {
    document.getElementById("auth-error").textContent = "Error: " + err.message;
    document.getElementById("auth-error").style.display = "block";
  }
}

function renderDashboard() {
  // Summary
  document.getElementById("total-bots").textContent = data.summary.totalBots;
  document.getElementById("total-visits").textContent = data.summary.totalVisits.toLocaleString();

  const today = new Date().toISOString().slice(0, 10);
  const todayVisits = data.daily[today]
    ? Object.values(data.daily[today]).reduce((a, b) => a + b, 0)
    : 0;
  document.getElementById("today-visits").textContent = todayVisits.toLocaleString();

  const weekVisits = Object.values(data.daily).reduce(
    (sum, day) => sum + Object.values(day).reduce((a, b) => a + b, 0), 0
  );
  document.getElementById("week-visits").textContent = weekVisits.toLocaleString();

  renderBotChart();
  renderBotTable();
  renderDailyChart();
  renderPagesTable();
  renderRecentLog();
}

function renderBotChart() {
  const container = document.getElementById("bot-chart");
  const totals = data.totals || {};
  const sorted = Object.entries(totals).sort((a, b) => Number(b[1]) - Number(a[1]));
  const max = sorted.length ? Number(sorted[0][1]) : 1;

  if (!sorted.length) {
    container.innerHTML = '<div class="empty-state">No AI crawler visits recorded yet.</div>';
    return;
  }

  container.innerHTML = sorted.map(([bot, count]) => `
    <div class="bar-row">
      <div class="bar-label">${bot}</div>
      <div class="bar-track">
        <div class="bar-fill" style="width: ${(Number(count) / max * 100).toFixed(1)}%"></div>
      </div>
      <div class="bar-count">${Number(count).toLocaleString()}</div>
    </div>
  `).join("");
}

function renderBotTable() {
  const tbody = document.getElementById("bot-table-body");
  const totals = data.totals || {};
  const sorted = Object.entries(totals).sort((a, b) => Number(b[1]) - Number(a[1]));

  if (!sorted.length) {
    tbody.innerHTML = '<tr><td colspan="3" class="empty-state">No data yet</td></tr>';
    return;
  }

  tbody.innerHTML = sorted.map(([bot, count]) => `
    <tr>
      <td><span class="bot-badge">${bot}</span></td>
      <td><span class="org-badge">${AI_ORGS[bot] || "Unknown"}</span></td>
      <td><strong>${Number(count).toLocaleString()}</strong></td>
    </tr>
  `).join("");
}

function renderDailyChart() {
  const container = document.getElementById("daily-chart");
  const daily = data.daily || {};
  const dates = Object.keys(daily).sort();

  if (!dates.length) {
    container.innerHTML = '<div class="empty-state">No daily data yet.</div>';
    return;
  }

  let html = "";
  const maxDaily = Math.max(...dates.map(d =>
    Object.values(daily[d]).reduce((a, b) => a + b, 0)
  ), 1);

  for (const date of dates) {
    const dayTotal = Object.values(daily[date]).reduce((a, b) => a + b, 0);
    html += `
      <div class="bar-row">
        <div class="bar-label">${date}</div>
        <div class="bar-track">
          <div class="bar-fill" style="width: ${(dayTotal / maxDaily * 100).toFixed(1)}%"></div>
        </div>
        <div class="bar-count">${dayTotal}</div>
      </div>
    `;
  }
  container.innerHTML = html;
}

function renderPagesTable() {
  const tbody = document.getElementById("pages-table-body");
  const pages = data.pages || {};
  const rows = [];

  for (const [bot, pageData] of Object.entries(pages)) {
    for (const [path, count] of Object.entries(pageData)) {
      rows.push({ bot, path, count: Number(count) });
    }
  }
  rows.sort((a, b) => b.count - a.count);

  if (!rows.length) {
    tbody.innerHTML = '<tr><td colspan="3" class="empty-state">No page data yet</td></tr>';
    return;
  }

  tbody.innerHTML = rows.slice(0, 50).map(r => `
    <tr>
      <td><code>${r.path}</code></td>
      <td><span class="bot-badge">${r.bot}</span></td>
      <td><strong>${r.count}</strong></td>
    </tr>
  `).join("");
}

function renderRecentLog() {
  const container = document.getElementById("recent-log");
  const visits = data.recentVisits || [];

  if (!visits.length) {
    container.innerHTML = '<div class="empty-state">No recent visits recorded.</div>';
    return;
  }

  container.innerHTML = visits.map(v => `
    <div class="visit-item">
      <span class="visit-time">${v.ts ? new Date(v.ts).toLocaleString() : "—"}</span>
      <span class="bot-badge">${v.bot || "?"}</span>
      <span class="visit-path">${v.path || "/"}</span>
    </div>
  `).join("");
}

// Tab switching
document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById("tab-" + tab.dataset.tab).classList.add("active");
  });
});

// Auto-login with saved key
const savedKey = localStorage.getItem("door-site-dash-key");
if (savedKey) {
  dashboardKey = savedKey;
  document.getElementById("key-input").value = savedKey;
  loadDashboard();
}
</script>

</body>
</html>
